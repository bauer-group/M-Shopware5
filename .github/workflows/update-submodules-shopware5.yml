name: Update Shopware 5 Submodules

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-from-repository]    
  schedule:
    - cron: "45 23 * * 6"  # jeden Samstag 23:45 UTC

permissions:
  contents: write
  actions: read

jobs:
  sync-shopware5:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Setup environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq gh
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Fetch all repos with topic shopware5-plugins
        id: fetch
        run: |
          ORG="${{ github.repository_owner }}"
          echo "Fetching repos for org: $ORG"

          # Abrufen der Repos mit Topic shopware5-plugins
          gh api orgs/$ORG/repos --paginate --jq '
            [.[] 
              | select(.topics[]? == "shopware5-plugins") 
              | {
                  name: .name,
                  default_branch: .default_branch,
                  html_url: .html_url,
                  git_url: .git_url,
                  description: .description
                }
            ]' > repos.json

          # JSON-Felder sortieren und pretty-formatieren
          jq '[.[] | {name, default_branch, html_url, git_url, description}]' repos.json | jq . > repos_pretty.json
          mv repos_pretty.json repos.json

          echo "Found $(jq length repos.json) repositories with topic shopware5-plugins:"
          jq -r '.[].name' repos.json

      - name: Sync submodules (add / update / remove)
        run: |
          BASE_DIR="Plugins"
          mkdir -p "$BASE_DIR"

          # Liste der gÃ¼ltigen Plugin-Repos (nach Prefix-Bereinigung)
          jq -r '.[].name' repos.json | sed -E 's/^SWP[-_]//i' > plugins.txt

          echo "ðŸ§¹ Checking for outdated submodules..."
          find "$BASE_DIR" -mindepth 1 -maxdepth 1 -type d | while read -r dir; do
            plugin=$(basename "$dir")
            if ! grep -qx "$plugin" plugins.txt; then
              echo "Removing obsolete submodule: $plugin"
              git submodule deinit -f "$dir" || true
              git rm -f "$dir" || true
              rm -rf ".git/modules/$dir" || true
              rm -rf "$dir"
            fi
          done

          echo "ðŸ”„ Syncing submodules..."
          while read -r row; do
            name=$(echo "$row" | jq -r '.name')
            branch=$(echo "$row" | jq -r '.default_branch')
            url=$(echo "$row" | jq -r '.html_url')
            git_url=$(echo "$row" | jq -r '.git_url')
            desc=$(echo "$row" | jq -r '.description')
            clean_name=$(echo "$name" | sed -E 's/^SWP[-_]//i')
            path="$BASE_DIR/$clean_name"

            if [ ! -d "$path" ]; then
              echo "Adding new submodule: $clean_name (branch: $branch)"
              git submodule add -b "$branch" "$url" "$path" || true
            else
              echo "Updating existing submodule: $clean_name (branch: $branch)"
              (
                cd "$path"
                git fetch origin "$branch" --depth 1 || true
                git checkout "$branch" 2>/dev/null || git checkout -B "$branch" "origin/$branch" || true
                git pull origin "$branch" || true
              )
            fi

            # Submodule auf aktuelles Commit setzen
            latest_commit=$(cd "$path" && git rev-parse HEAD)
            git add "$path"
          done < <(jq -c '.[]' repos.json)

      - name: Generate README.md
        run: |
          echo "# ðŸ§© Shopware 5 Plugins" > README.md
          echo "" >> README.md
          echo "Dieses Repository bÃ¼ndelt automatisch alle **Shopware 5 Plugins** aus der Organisation \`${{ github.repository_owner }}\` mit dem Topic \`shopware5-plugins\`." >> README.md
          echo "" >> README.md
          echo "## ðŸ“¦ Enthaltene Plugins" >> README.md
          echo "" >> README.md
          echo "| Plugin | Beschreibung | Repository |" >> README.md
          echo "|--------|---------------|-------------|" >> README.md

          jq -r '.[] | "| **\(.name | sub("^SWP[-_]" ; ""))** | \(.description // "_Keine Beschreibung verfÃ¼gbar_") | [Link](\(.html_url)) |"' repos.json >> README.md

          echo "" >> README.md
          echo "---" >> README.md
          echo "_Automatisch generiert: $(date -u '+%Y-%m-%d %H:%M UTC')_" >> README.md

      - name: Commit and push changes
        run: |
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ”„ Weekly auto-sync: Shopware 5 plugins"
            git push origin main
          else
            echo "No changes to commit."
          fi
